<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compute Graph Viewer</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="toolbar">
  <div class="toolbar-l">
    <div class="toolbar-logo">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <rect x="1" y="1" width="7" height="7" rx="1.5" fill="var(--op-accent)"/>
        <rect x="10" y="1" width="7" height="7" rx="1.5" fill="var(--tensor-accent)"/>
        <rect x="1" y="10" width="7" height="7" rx="1.5" fill="var(--incast-accent)"/>
        <rect x="10" y="10" width="7" height="7" rx="1.5" fill="var(--outcast-accent)"/>
      </svg>
      <span>Compute Graph</span>
    </div>
    <div class="graph-picker" id="graphPicker">
      <button class="btn" id="loadBtn">
        <svg width="13" height="13" viewBox="0 0 13 13" fill="none">
          <rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.7"/>
          <rect x="8" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.7"/>
          <rect x="1" y="8" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.7"/>
          <rect x="8" y="8" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.7"/>
        </svg>
        Select Graph
        <svg width="9" height="9" viewBox="0 0 9 9" fill="none" style="opacity:0.5">
          <path d="M1.5 3l3 3 3-3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="graph-menu" id="graphMenu">
        <button class="graph-menu-item" data-sample="deepseek_out_pass/After_000_RemoveRedundantReshape_TENSOR_LOOP_RESHAPE_Unroll1_PATH0_4.json" data-label="LOOP_RESHAPE · PATH0">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          LOOP_RESHAPE · PATH0
        </button>
        <button class="graph-menu-item" data-sample="deepseek_out_pass/After_000_RemoveRedundantReshape_TENSOR_IndexerPrologQuantQuantLoop_Unroll1_PATH0_6.json" data-label="QuantLoop · PATH0">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          QuantLoop · PATH0
        </button>
        <button class="graph-menu-item" data-sample="deepseek_out_pass/sample_computation_graph.json" data-label="MLA Prolog Quant · Sample">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          MLA Prolog Quant · Sample
        </button>
        <div class="graph-menu-sep"></div>
        <button class="graph-menu-item" id="graphMenuLocal">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M1 9.5V8l1.5-1.5H5L6 5h4.5a.5.5 0 01.5.5v4a.5.5 0 01-.5.5H1.5A.5.5 0 011 9.5z" stroke="currentColor" stroke-width="1.1" stroke-linejoin="round"/>
            <path d="M3.5 4V2.5A.5.5 0 014 2h4.5l1 1.5" stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Open Local File...
        </button>
      </div>
    </div>
    <input type="file" id="fileInput" accept=".json">
    <div class="toolbar-sep"></div>
    <span class="graph-title" id="graphTitle"></span>
    <div class="graph-stats" id="graphStats"></div>
  </div>
</header>

<div class="viewport" id="viewport">
  <div class="graph-root" id="graphRoot">
    <svg class="edges-svg" id="edgesSvg" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrow-default" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <path d="M0,0 L0,6 L6,3 z" fill="rgba(255,255,255,0.15)"/>
        </marker>
        <marker id="arrow-incast" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <path d="M0,0 L0,6 L6,3 z" fill="var(--incast-accent)"/>
        </marker>
        <marker id="arrow-op" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <path d="M0,0 L0,6 L6,3 z" fill="var(--op-accent)"/>
        </marker>
        <marker id="arrow-outcast" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <path d="M0,0 L0,6 L6,3 z" fill="var(--outcast-accent)"/>
        </marker>
      </defs>
    </svg>
    <div class="nodes-layer" id="nodesLayer"></div>
  </div>

  <!-- Empty state -->
  <div class="empty-state" id="emptyState">
    <div class="empty-card">
      <div class="empty-icon-wrap">
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
          <rect x="4" y="20" width="18" height="14" rx="4" fill="var(--incast-accent)" fill-opacity="0.9"/>
          <rect x="23" y="8"  width="18" height="14" rx="4" fill="var(--op-accent)"     fill-opacity="0.9"/>
          <rect x="23" y="32" width="18" height="14" rx="4" fill="var(--tensor-accent)" fill-opacity="0.9"/>
          <rect x="42" y="20" width="18" height="14" rx="4" fill="var(--outcast-accent)" fill-opacity="0.9"/>
          <path d="M22 27h1M41 27h1M32 22v-1M32 32v1" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <h2 class="empty-title">Compute Graph Viewer</h2>
      <p class="empty-sub">Visualize Ascend NPU computation graphs</p>
      <div class="empty-actions">
        <button class="btn-md-primary" id="emptyLoadBtn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 2v8M4.5 6.5L8 10l3.5-3.5M2 13h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Open JSON File
        </button>
        <div class="recent-row" id="recentRow">
          <span class="recent-label">Recent</span>
          <button class="recent-chip" id="recentChip">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
              <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.2"/>
              <path d="M6 3.5V6l1.5 1.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
            <span id="recentName">—</span>
          </button>
        </div>
      </div>
      <div class="sample-row">
        <span class="recent-label">Samples</span>
        <button class="recent-chip sample-chip" data-sample="deepseek_out_pass/After_000_RemoveRedundantReshape_TENSOR_LOOP_RESHAPE_Unroll1_PATH0_4.json" data-label="LOOP_RESHAPE · PATH0">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          LOOP_RESHAPE · PATH0
        </button>
        <button class="recent-chip sample-chip" data-sample="deepseek_out_pass/After_000_RemoveRedundantReshape_TENSOR_IndexerPrologQuantQuantLoop_Unroll1_PATH0_6.json" data-label="QuantLoop · PATH0">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          QuantLoop · PATH0
        </button>
        <button class="recent-chip sample-chip" data-sample="deepseek_out_pass/sample_computation_graph.json" data-label="MLA Prolog Quant · Sample">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="1" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="1" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/><rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor" fill-opacity="0.6"/></svg>
          MLA · Sample
        </button>
      </div>
      <p class="empty-hint">or drag &amp; drop a .json file anywhere</p>
    </div>
  </div>

  <!-- Color panel (top-right of canvas) -->
  <div class="color-panel" id="colorPanel">
    <div class="cp-header">
      <span class="cp-label">Color by</span>
    </div>
    <div class="cp-buttons">
      <button class="cp-btn active" data-mode="none">
        <span class="cp-btn-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
            <rect x="13" y="3" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
            <rect x="3" y="13" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
            <rect x="13" y="13" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
          </svg>
        </span>
        <span class="cp-btn-text">
          <span class="cp-btn-label">Structure</span>
          <span class="cp-btn-sub">Node type</span>
        </span>
      </button>
      <button class="cp-btn" data-mode="semantic">
        <span class="cp-btn-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.8"/>
            <path d="M7 8c0-2.76 2.24-5 5-5 1.38 0 2.63.56 3.54 1.46" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M7 13h10M9 17h6M11 21h2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="cp-btn-text">
          <span class="cp-btn-label">Semantic</span>
          <span class="cp-btn-sub">Op labels</span>
        </span>
      </button>
      <button class="cp-btn" data-mode="latency">
        <span class="cp-btn-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z" stroke="currentColor" stroke-width="1.8"/>
            <path d="M12 12L8.5 8.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            <circle cx="12" cy="12" r="1.2" fill="currentColor"/>
            <path d="M6.5 12H5M18.5 12H19M12 6.5V5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="cp-btn-text">
          <span class="cp-btn-label">Latency</span>
          <span class="cp-btn-sub">Execution cycles</span>
        </span>
      </button>
      <button class="cp-btn" data-mode="subgraph">
        <span class="cp-btn-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <rect x="9" y="2" width="6" height="5" rx="1" stroke="currentColor" stroke-width="1.8"/>
            <rect x="2" y="17" width="6" height="5" rx="1" stroke="currentColor" stroke-width="1.8"/>
            <rect x="16" y="17" width="6" height="5" rx="1" stroke="currentColor" stroke-width="1.8"/>
            <path d="M12 7v4M12 11H5v5M12 11h7v5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span class="cp-btn-text">
          <span class="cp-btn-label">Partition</span>
          <span class="cp-btn-sub">Subgraph ID</span>
        </span>
      </button>
    </div>
    <div class="cp-divider"></div>
    <div class="legend" id="legend">
      <span class="legend-item"><span class="legend-dot" style="background:var(--incast-accent)"></span>Incast</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--op-accent)"></span>Op</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--tensor-accent)"></span>Tensor</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--outcast-accent)"></span>Outcast</span>
    </div>
  </div>

  <!-- Minimap with zoom controls -->
  <div class="minimap" id="minimap">
    <canvas id="minimapCanvas" width="240" height="140"></canvas>
    <div class="minimap-viewport" id="minimapViewport"></div>
    <div class="minimap-controls">
      <button class="mm-btn" id="zoomOutBtn" title="Zoom Out">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M3 7h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
      <span class="zoom-label" id="zoomLabel">100%</span>
      <button class="mm-btn" id="zoomInBtn" title="Zoom In">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 3v8M3 7h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
      <div class="mm-sep"></div>
      <button class="mm-btn mm-fit" id="fitBtn" title="Fit View">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1 5V2h3M10 2h3v3M13 9v3h-3M4 13H1v-3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</div>

<aside class="detail-panel" id="detailPanel">
  <div class="detail-header">
    <div class="detail-type-badge" id="detailBadge"></div>
    <span class="detail-name" id="detailName"></span>
    <button class="btn btn-icon detail-close" id="detailClose">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
        <path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
  <div class="detail-body" id="detailBody"></div>
</aside>

<script src="js/colormap.js"></script>
<script src="js/parser.js"></script>
<script src="js/layout.js"></script>
<script src="js/renderer.js"></script>
<script src="js/app.js"></script>
</body>
</html>
